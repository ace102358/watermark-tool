<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>é‡‘æ˜‡å·¥ä½œå®¤æ°´å° Pro v2.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<!-- Google Fonts + å°ç£å¸¸ç”¨å­—å‹ CDN -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;700&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Taipei+Sans+TC+Beta&family=jf-openhuninn-2:wght@0.5;1&family=King+Nam+Lion&family=Ma+Shan+Zheng&family=Liu+Jian+Mao+Cao&family=Inter:wght@400;700&family=Playfair+Display&family=Dancing+Script&family=Bebas+Neue&display=swap" rel="stylesheet">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');
  body{font-family:'Noto Sans TC',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);margin:0;padding:20px 0;min-height:100vh;}
  .container{max-width:1400px;margin:0 auto;background:white;border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.25);}
  header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:30px;text-align:center;}
  header h1{font-size:2.8rem;margin:0;font-weight:700;}
  header p{font-size:1.1rem;opacity:0.9;}
  .main{display:flex;flex-wrap:wrap;}
  .preview-area{flex:2;background:#0f0f1a;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;padding:30px;}
  #previewCanvas{max-width:100%;max-height:100%;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,0.6);transition:all 0.4s;position:absolute;}
  .watermark-text{position:absolute;user-select:none;pointer-events:none;color:white;text-shadow:0 3px 12px rgba(0,0,0,0.8);}
  .tile-preview{pointer-events:none;position:absolute;top:0;left:0;width:100%;height:100%;padding:30px;}
  .controls{flex:1;min-width:380px;background:#fbfbfb;padding:40px 35px;}
  .control-group{margin-bottom:30px;}
  label{display:flex;align-items:center;justify-content:space-between;font-weight:600;color:#333;font-size:15px;}
  .value{font-weight:700;color:#667eea;}
  input[type="range"]{width:100%;height:10px;border-radius:10px;background:#ddd;outline:none;appearance:none;margin:14px 0;}
  input[type="range"]::-webkit-slider-thumb{appearance:none;width:28px;height:28px;border-radius:50%;background:#667eea;cursor:pointer;box-shadow:0 5px 15px rgba(102,126,234,0.5);}
  input[type="color"]{width:100%;height:56px;border:none;border-radius:14px;cursor:pointer;}
  input[type="text"], select{font-size:16px;padding:16px;border:2px solid #eee;border-radius:14px;transition:0.3s;width:100%;box-sizing:border-box;}
  input[type="text"]:focus, select:focus{border-color:#667eea;outline:none;}
  input[type="file"]{width:100%;padding:16px;border:2px dashed #ccc;border-radius:14px;background:#fafafa;font-size:15px;}
  .switch{position:relative;display:inline-block;width:70px;height:38px;}
  .switch input{opacity:0;width:0;height:0;}
  .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:38px;}
  .slider:before{position:absolute;content:"";height:30px;width:30px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%;}
  input:checked + .slider{background:#667eea;}
  input:checked + .slider:before{transform:translateX(32px);}
  .position-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:14px;}
  .pos-btn{padding:18px;background:#f5f5f5;border-radius:14px;text-align:center;cursor:pointer;transition:0.3s;font-weight:600;}
  .pos-btn:hover{background:#e6e6ff;}
  .pos-btn.active{background:#667eea;color:white;}
  button.main-btn{width:100%;padding:20px;margin-top:20px;border:none;border-radius:16px;font-size:19px;font-weight:700;color:white;cursor:pointer;transition:0.4s;}
  #downloadBtn{background:#667eea;}
  #batchBtn{background:#e91e63;display:none;}
  #saveBtn{background:#4caf50;}
  #loadBtn{background:#ff9800;}
  button.main-btn:hover{transform:translateY(-4px);box-shadow:0 15px 30px rgba(0,0,0,0.25);}
  .progress{margin-top:20px;height:10px;background:#eee;border-radius:5px;overflow:hidden;display:none;}
  .progress-bar{height:100%;background:#667eea;width:0%;transition:all 0.5s;border-radius:5px;}
  .btn-group{display:flex;gap:12px;}
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>é‡‘æ˜‡å·¥ä½œå®¤æ°´å° Pro v2.0</h1>
    <p>å³æ™‚é è¦½ â€¢ å¹³é‹ª â€¢ æ‹–æ›³å®šä½ â€¢ æ‰¹é‡æ‰“åŒ… ZIP â€¢ å­—å‹é¸æ“‡ â€¢ è¨­å®šå„²å­˜</p>
  </header>

  <div class="main">
    <div class="preview-area" id="previewArea">
      <canvas id="previewCanvas"></canvas>
      <div id="watermarkText" class="watermark-text">Â© 2025 æˆ‘çš„ç‰ˆæ¬Š</div>
      <div class="tile-preview" id="tilePreview"></div>
      <div id="placeholder" style="color:#888;font-size:26px;z-index:1;">è«‹ä¸Šå‚³åœ–ç‰‡ï¼ˆæ”¯æ´å¤šé¸ï¼‰</div>
    </div>

    <div class="controls">
      <div class="control-group">
        <input type="file" id="imageUpload" accept="image/*" multiple>
        <small style="color:#888;display:block;margin-top:8px;">å–®å¼µå³æ™‚é è¦½ â€¢ å¤šå¼µè‡ªå‹•æ‰¹æ¬¡æ‰“åŒ…</small>
      </div>

      <div class="control-group">
        <label>æ°´å°æ–‡å­—</label>
        <input type="text" id="text" value="Â© 2025 æˆ‘çš„ç‰ˆæ¬Š" placeholder="è¼¸å…¥ä½ çš„æ°´å°">
      </div>

      <div class="control-group">
  <label>å­—å‹é¸æ“‡</label>
  <select id="fontFamily">
    <!-- ç¹é«”ä¸­æ–‡ -->
    <option value="'Noto Sans TC', sans-serif">æ€æºé»‘é«” Noto Sans TCï¼ˆé è¨­ï¼‰</option>
    <option value="'Noto Serif TC', serif">æ€æºå®‹é«” Noto Serif TC</option>
    <option value="'Taipei Sans TC Beta', sans-serif">å°åŒ—é»‘é«” Taipei Sans TCï¼ˆå®˜æ–¹ï¼‰</option>
    <option value="'jf-openhuninn-2', cursive">jf ç²‰åœ“ï¼ˆè¶…å¯æ„›æ‰‹å¯«é¢¨ï¼‰</option>
    <option value="'King Nam Lion', serif">é‡‘è±é«” King Nam Lionï¼ˆé«˜ç´šæ„Ÿï¼‰</option>
    <option value="'Ma Shan Zheng', cursive">æ‰‹æ›¸é«” Ma Shan Zhengï¼ˆç°½åæ„Ÿï¼‰</option>
    <option value="'Liu Jian Mao Cao', cursive">åŠ‰å …æ¯›è‰ï¼ˆç‹‚è‰é¢¨ï¼‰</option>
    
    <!-- è‹±æ–‡ & è¨­è¨ˆå­—å‹ -->
    <optgroup label="â”€â”€ è‹±æ–‡ / è¨­è¨ˆå­—å‹ â”€â”€">
      <option value="Inter, sans-serif">Interï¼ˆæœ€æ½®ç¾ä»£ç„¡è¥¯ç·šï¼‰</option>
      <option value="'Playfair Display', serif">Playfair Displayï¼ˆå¥¢è¯è¥¯ç·šï¼‰</option>
      <option value="'Dancing Script', cursive">Dancing Scriptï¼ˆè‹±æ–‡æ‰‹å¯«ï¼‰</option>
      <option value="'Bebas Neue', display">Bebas Neueï¼ˆæµ·å ±ç²—é»‘ï¼‰</option>
      <option value="'Roboto', sans-serif">Robotoï¼ˆç¶“å…¸ç©©é‡ï¼‰</option>
    </optgroup>
  </select>
</div>

      <div class="control-group">
        <label>å­—å‹å¤§å° <span class="value" id="sizeValue">48</span> px</label>
        <input type="range" id="size" min="10" max="300" value="48">
      </div>

      <div class="control-group">
        <label>æ–‡å­—é¡è‰²</label>
        <input type="color" id="color" value="#ffffff">
      </div>

      <div class="control-group">
        <label>é€æ˜åº¦ <span class="value" id="opacityValue">55</span>%</label>
        <input type="range" id="opacity" min="0" max="100" value="55">
      </div>

      <div class="control-group">
        <label>æ—‹è½‰è§’åº¦ <span class="value" id="rotateValue">335</span>Â°</label>
        <input type="range" id="rotate" min="0" max="360" value="335">
      </div>

      <div class="control-group">
        <label>å¹³é‹ªæ°´å°
          <label class="switch">
            <input type="checkbox" id="tileMode">
            <span class="slider"></span>
          </label>
        </label>
        <div id="tileOptions" style="margin-top:18px;display:none;">
          <label>å¹³é‹ªé–“è· <span class="value" id="tileGapValue">180</span> px</label>
          <input type="range" id="tileGap" min="80" max="500" value="180">
        </div>
      </div>

      <div class="control-group">
        <label>å¿«é€Ÿå®šä½ï¼ˆå–®å¼µæ¨¡å¼ï¼‰</label>
        <div class="position-grid">
          <div class="pos-btn" data-pos="tl">å·¦ä¸Š</div><div class="pos-btn" data-pos="tc">ä¸Šä¸­</div><div class="pos-btn" data-pos="tr">å³ä¸Š</div>
          <div class="pos-btn" data-pos="cl">å·¦ä¸­</div><div class="pos-btn" data-pos="cc">æ­£ä¸­</div><div class="pos-btn" data-pos="cr">å³ä¸­</div>
          <div class="pos-btn" data-pos="bl">å·¦ä¸‹</div><div class="pos-btn" data-pos="bc">ä¸‹ä¸­</div><div class="pos-btn active" data-pos="br">å³ä¸‹</div>
        </div>
      </div>

      <div class="btn-group">
        <button class="main-btn" id="saveBtn">ğŸ’¾ ä¿å­˜ç›®å‰è¨­å®š</button>
        <button class="main-btn" id="loadBtn">ğŸ“‚ è¼‰å…¥ä¸Šæ¬¡è¨­å®š</button>
      </div>

      <button class="main-btn" id="downloadBtn">ä¸‹è¼‰å–®å¼µåœ–ç‰‡</button>
      <button class="main-btn" id="batchBtn">æ‰¹é‡è™•ç†ä¸¦ä¸‹è¼‰ ZIP (<span id="count">0</span> å¼µ)</button>
      <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
    </div>
  </div>
</div>

<script>
const canvas = document.getElementById('previewCanvas');
const ctx = canvas.getContext('2d');
const previewArea = document.getElementById('previewArea');
const watermark = document.getElementById('watermarkText');
const tilePreview = document.getElementById('tilePreview');
const placeholder = document.getElementById('placeholder');

let img = new Image();
let files = [];
let scale = 1, offsetX = 0, offsetY = 0;
let watermarkX = 0.85, watermarkY = 0.85;
let dragging = false;

// ================ è¨­å®šå„²å­˜/è¼‰å…¥ ================
const SETTINGS_KEY = 'watermarkMasterPro_v2_settings';

function saveSettings() {
  const settings = {
    text: document.getElementById('text').value,
    fontFamily: document.getElementById('fontFamily').value,
    size: document.getElementById('size').value,
    color: document.getElementById('color').value,
    opacity: document.getElementById('opacity').value,
    rotate: document.getElementById('rotate').value,
    tileMode: document.getElementById('tileMode').checked,
    tileGap: document.getElementById('tileGap').value,
    watermarkX, watermarkY
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  alert('âœ… è¨­å®šå·²å„²å­˜ï¼ä¸‹æ¬¡é–‹å•Ÿæœƒè‡ªå‹•è¼‰å…¥');
}

function loadSettings() {
  const saved = localStorage.getItem(SETTINGS_KEY);
  if (!saved) return alert('âš ï¸ é‚„æ²’æœ‰å„²å­˜çš„è¨­å®š');
  
  const s = JSON.parse(saved);
  document.getElementById('text').value = s.text || 'Â© 2025 æˆ‘çš„ç‰ˆæ¬Š';
  document.getElementById('fontFamily').value = s.fontFamily || "'Noto Sans TC', sans-serif";
  document.getElementById('size').value = s.size || 48;
  document.getElementById('color').value = s.color || '#ffffff';
  document.getElementById('opacity').value = s.opacity || 55;
  document.getElementById('rotate').value = s.rotate || 335;
  document.getElementById('tileMode').checked = !!s.tileMode;
  document.getElementById('tileGap').value = s.tileGap || 180;
  watermarkX = s.watermarkX || 0.85;
  watermarkY = s.watermarkY || 0.85;

  document.getElementById('tileOptions').style.display = s.tileMode ? 'block' : 'none';
  updateAll();
  alert('âœ… å·²è¼‰å…¥ä¸Šæ¬¡è¨­å®š');
}

// ================ å…¶é¤˜åŠŸèƒ½ï¼ˆä¿æŒä¸è®Šï¼ŒåªåŠ å…¥å­—å‹åƒæ•¸ï¼‰ ================
function updateAll() {
  document.getElementById('sizeValue').textContent = document.getElementById('size').value;
  document.getElementById('opacityValue').textContent = document.getElementById('opacity').value;
  document.getElementById('rotateValue').textContent = document.getElementById('rotate').value;
  document.getElementById('tileGapValue').textContent = document.getElementById('tileGap').value;

  if (!img.src) return;
  drawCanvas();
  updateWatermarkOverlay();
  updateTilePreview();
}

function resizeAndCenter() {
  if (!img.src) return;
  const areaW = previewArea.clientWidth - 60;
  const areaH = previewArea.clientHeight - 60;
  scale = Math.min(areaW / img.width, areaH / img.height, 1);
  canvas.width = img.width * scale;
  canvas.height = img.height * scale;
  offsetX = (previewArea.clientWidth - canvas.width) / 2;
  offsetY = (previewArea.clientHeight - canvas.height) / 2;
  canvas.style.left = offsetX + 'px';
  canvas.style.top = offsetY + 'px';
  updateAll();
}

function getFontString(size) {
  return `bold ${size}px ${document.getElementById('fontFamily').value}, Arial, "Noto Sans TC"`;
}

function drawCanvas() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  const text = document.getElementById('text').value || 'æ°´å°';
  const size = parseInt(document.getElementById('size').value) * scale;
  const opacity = document.getElementById('opacity').value / 100;
  const rotate = document.getElementById('rotate').value * Math.PI / 180;

  ctx.font = getFontString(size);
  ctx.fillStyle = document.getElementById('color').value;
  ctx.globalAlpha = opacity;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  if (document.getElementById('tileMode').checked) {
    const gap = parseInt(document.getElementById('tileGap').value) * scale;
    for (let x = gap; x < canvas.width; x += gap) {
      for (let y = gap; y < canvas.height; y += gap) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rotate);
        ctx.fillText(text, 0, 0);
        ctx.restore();
      }
    }
  } else {
    const x = canvas.width * watermarkX;
    const y = canvas.height * watermarkY;
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(rotate);
    ctx.fillText(text, 0, 0);
    ctx.restore();
  }
}

function updateWatermarkOverlay() {
  if (document.getElementById('tileMode').checked) {
    watermark.style.display = 'none';
    return;
  }
  watermark.style.display = 'block';
  watermark.textContent = document.getElementById('text').value || 'æ°´å°';
  watermark.style.fontSize = (parseInt(document.getElementById('size').value) * scale) + 'px';
  watermark.style.fontFamily = document.getElementById('fontFamily').value;
  watermark.style.color = document.getElementById('color').value;
  watermark.style.opacity = document.getElementById('opacity').value / 100;
  watermark.style.transform = `translate(-50%,-50%) rotate(${document.getElementById('rotate').value}deg)`;
  watermark.style.left = (offsetX + canvas.width * watermarkX) + 'px';
  watermark.style.top = (offsetY + canvas.height * watermarkY) + 'px';
}

function updateTilePreview() {
  tilePreview.innerHTML = '';
  if (!document.getElementById('tileMode').checked || !img.src) return;

  const gap = parseInt(document.getElementById('tileGap').value) * scale;
  const size = parseInt(document.getElementById('size').value) * scale * 0.7;

  for (let x = gap; x < canvas.width; x += gap) {
    for (let y = gap; y < canvas.height; y += gap) {
      const div = document.createElement('div');
      div.textContent = document.getElementById('text').value || 'æ°´å°';
      div.style.position = 'absolute';
      div.style.left = (offsetX + x) + 'px';
      div.style.top = (offsetY + y) + 'px';
      div.style.fontSize = size + 'px';
      div.style.fontFamily = document.getElementById('fontFamily').value;
      div.style.color = '#ffffff';
      div.style.opacity = '0.18';
      div.style.transform = `translate(-50%,-50%) rotate(${document.getElementById('rotate').value}deg)`;
      div.style.pointerEvents = 'none';
      div.style.userSelect = 'none';
      tilePreview.appendChild(div);
    }
  }
}

// ==================== äº‹ä»¶ç›£è½ ====================
img.onload = resizeAndCenter;
window.addEventListener('resize', resizeAndCenter);

document.getElementById('imageUpload').addEventListener('change', e => {
  files = Array.from(e.target.files);
  document.getElementById('count').textContent = files.length;
  document.getElementById('batchBtn').style.display = files.length > 1 ? 'block' : 'none';
  document.getElementById('downloadBtn').style.display = files.length <= 1 ? 'block' : 'none';
  
  if (files.length === 0) {
    placeholder.style.display = 'block';
    return;
  }
  placeholder.style.display = 'none';
  const reader = new FileReader();
  reader.onload = ev => { img.src = ev.target.result; };
  reader.readAsDataURL(files[0]);
});

['text', 'size', 'color', 'opacity', 'rotate', 'tileGap', 'fontFamily'].forEach(id => {
  document.getElementById(id).addEventListener('input', updateAll);
});

document.getElementById('tileMode').addEventListener('change', function() {
  document.getElementById('tileOptions').style.display = this.checked ? 'block' : 'none';
  updateAll();
});

// ä¹å®®æ ¼ã€æ‹–æ›³ã€å–®å¼µä¸‹è¼‰ã€æ‰¹æ¬¡ ZIP å®Œå…¨ä¿ç•™ï¼ˆåªæŠŠ font æ”¹æˆ getFontStringï¼‰
document.querySelectorAll('.pos-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (document.getElementById('tileMode').checked) return;
    document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const map = {
      tl:[0.15,0.15], tc:[0.5,0.15], tr:[0.85,0.15],
      cl:[0.15,0.5], cc:[0.5,0.5], cr:[0.85,0.5],
      bl:[0.15,0.85], bc:[0.5,0.85], br:[0.85,0.85]
    };
    [watermarkX, watermarkY] = map[btn.dataset.pos];
    updateAll();
  });
});

watermark.addEventListener('mousedown', e => {
  if (document.getElementById('tileMode').checked) return;
  dragging = true; e.preventDefault();
});
document.addEventListener('mousemove', e => {
  if (!dragging) return;
  const rect = previewArea.getBoundingClientRect();
  const x = e.clientX - rect.left - offsetX;
  const y = e.clientY - rect.top - offsetY;
  watermarkX = Math.max(0.05, Math.min(0.95, x / canvas.width));
  watermarkY = Math.max(0.05, Math.min(0.95, y / canvas.height));
  updateAll();
});
document.addEventListener('mouseup', () => dragging = false);

// ä¿å­˜èˆ‡è¼‰å…¥æŒ‰éˆ•
document.getElementById('saveBtn').addEventListener('click', saveSettings);
document.getElementById('loadBtn').addEventListener('click', loadSettings);

// å–®å¼µä¸‹è¼‰ï¼ˆåŠ å…¥å­—å‹ï¼‰
document.getElementById('downloadBtn').addEventListener('click', () => {
  if (!img.src) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼');

  const exportCanvas = document.createElement('canvas');
  const ectx = exportCanvas.getContext('2d');
  exportCanvas.width = img.width;
  exportCanvas.height = img.height;
  ectx.drawImage(img, 0, 0);

  const text = document.getElementById('text').value || 'æ°´å°';
  const size = parseInt(document.getElementById('size').value);
  const color = document.getElementById('color').value;
  const opacity = document.getElementById('opacity').value / 100;
  const rotate = document.getElementById('rotate').value * Math.PI / 180;
  const tileMode = document.getElementById('tileMode').checked;
  const tileGap = parseInt(document.getElementById('tileGap').value);

  ectx.font = getFontString(size);
  ectx.fillStyle = color;
  ectx.globalAlpha = opacity;
  ectx.textAlign = 'center';
  ectx.textBaseline = 'middle';

  if (tileMode) {
    for (let x = tileGap; x < img.width; x += tileGap) {
      for (let y = tileGap; y < img.height; y += tileGap) {
        ectx.save();
        ectx.translate(x, y);
        ectx.rotate(rotate);
        ectx.fillText(text, 0, 0);
        ectx.restore();
      }
    }
  } else {
    const x = img.width * watermarkX;
    const y = img.height * watermarkY;
    ectx.save();
    ectx.translate(x, y);
    ectx.rotate(rotate);
    ectx.fillText(text, 0, 0);
    ectx.restore();
  }

  exportCanvas.toBlob(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (files[0]?.name.split('.').slice(0,-1).join('.') || 'æ°´å°åœ–ç‰‡') + '_æ°´å°.png';
    a.click();
    URL.revokeObjectURL(url);
  }, 'image/png', 0.98);
});

// æ‰¹æ¬¡ ZIPï¼ˆåŠ å…¥å­—å‹èˆ‡ä½ç½®ï¼‰
document.getElementById('batchBtn').addEventListener('click', async () => {
  if (files.length <= 1) return;

  const zip = new JSZip();
  const progressContainer = document.querySelector('.progress');
  const progressBar = document.getElementById('progressBar');
  progressContainer.style.display = 'block';

  const settings = {
    text: document.getElementById('text').value || 'æ°´å°',
    font: document.getElementById('fontFamily').value,
    size: parseInt(document.getElementById('size').value),
    color: document.getElementById('color').value,
    opacity: document.getElementById('opacity').value / 100,
    rotate: document.getElementById('rotate').value * Math.PI / 180,
    tileMode: document.getElementById('tileMode').checked,
    tileGap: parseInt(document.getElementById('tileGap').value),
    posX: watermarkX,
    posY: watermarkY
  };

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const blob = await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => {
        const tempImg = new Image();
        tempImg.onload = () => {
          const c = document.createElement('canvas');
          c.width = tempImg.width;
          c.height = tempImg.height;
          const ctx = c.getContext('2d');
          ctx.drawImage(tempImg, 0, 0);

          ctx.font = `bold ${settings.size}px ${settings.font}, Arial, "Noto Sans TC"`;
          ctx.fillStyle = settings.color;
          ctx.globalAlpha = settings.opacity;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';

          if (settings.tileMode) {
            for (let x = settings.tileGap; x < tempImg.width; x += settings.tileGap) {
              for (let y = settings.tileGap; y < tempImg.height; y += settings.tileGap) {
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(settings.rotate);
                ctx.fillText(settings.text, 0, 0);
                ctx.restore();
              }
            }
          } else {
            const px = tempImg.width * settings.posX;
            const py = tempImg.height * settings.posY;
            ctx.save();
            ctx.translate(px, py);
            ctx.rotate(settings.rotate);
            ctx.fillText(settings.text, 0, 0);
            ctx.restore();
          }
          c.toBlob(resolve, 'image/png', 0.98);
        };
        tempImg.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    const ext = file.name.split('.').pop();
    const name = file.name.replace(new RegExp(`\\.${ext}$`, 'i'), '') + '_æ°´å°.png';
    zip.file(name, blob);

    progressBar.style.width = ((i + 1) / files.length * 100) + '%';
  }

  const content = await zip.generateAsync({type: 'blob'});
  const url = URL.createObjectURL(content);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'æ°´å°åœ–ç‰‡åˆé›†_' + Date.now() + '.zip';
  a.click();
  URL.revokeObjectURL(url);

  progressContainer.style.display = 'none';
  progressBar.style.width = '0%';
});

// å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡è¨­å®š
window.addEventListener('load', () => {
  setTimeout(loadSettings, 300); // ç¨å¾®å»¶é²ç¢ºä¿ DOM å°±ç·’
  updateAll();
});
</script>
</body>
</html>

